<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Melody Sequencer</title>
    <meta name="theme-color" content="#7c3aed">
    <link rel="icon" type="image/svg+xml" href="https://fonts.gstatic.com/s/i/short-term/release/materialsymbolsoutlined/music_note/default/48px.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script type="module">

    // DOM refs
    const sequencerContainer = document.getElementById('sequencer');
    const playButton = document.getElementById('play-btn');
    const saveButton = document.getElementById('save-btn');
    const loadButton = document.getElementById('load-btn');
    const stopButton = document.getElementById('stop-btn');
    const tempoSlider = document.getElementById('tempo');
    const statusMessage = document.getElementById('status-message');

    // Sound + grid
    const notes = ["C5", "B4", "A4", "G4", "F4", "E4", "D4", "C4"]; // high to low
    const noteLabels = ["C", "B", "A", "G", "F", "E", "D", "C"];
    const numSteps = 16;
    let grid = Array.from({length: notes.length}, () => Array(numSteps).fill(false));

    // Visual improved color palette
    const highlightColor = 'bg-yellow-300';
    const noteOnColor = 'bg-indigo-500';
    const noteOffColor = 'bg-white';

    // User state - removed Firebase auth state

    // Smoother synth
    const synth = new Tone.PolySynth(Tone.Synth, {
        envelope: { attack: 0.04, release: 0.2 },
        volume: -8,
    }).toDestination();

    // UI State
    let currentStep = 0;
    let loop = null;

    /** Utility */
    function showMessage(message, error) {
        statusMessage.textContent = message;
        statusMessage.classList.remove('hidden');
        if (error) {
          statusMessage.classList.add('text-red-600');
        } else {
          statusMessage.classList.remove('text-red-600');
        }
        setTimeout(() => {
            statusMessage.classList.add('hidden');
        }, 2500);
    }

    /** LocalStorage Functions */
    function savePattern() {
        try {
            const patternData = {
                notes: grid,
                tempo: Tone.Transport.bpm.value,
                timestamp: Date.now()
            };
            localStorage.setItem('melodyPattern', JSON.stringify(patternData));
            showMessage("Pattern saved locally!", false);
        } catch (error) {
            console.error("Save error:", error);
            showMessage("Save error", true);
        }
    }

    function loadPattern() {
        try {
            const savedData = localStorage.getItem('melodyPattern');
            if (savedData) {
                const patternData = JSON.parse(savedData);
                if (patternData.notes && patternData.notes.length === notes.length && patternData.notes[0].length === numSteps) {
                    setGrid(patternData.notes, true);
                    if (patternData.tempo) {
                        tempoSlider.value = patternData.tempo;
                        Tone.Transport.bpm.value = patternData.tempo;
                        document.getElementById('tempo-display').textContent = `${patternData.tempo} BPM`;
                    }
                    showMessage("Pattern loaded!", false);
                } else {
                    showMessage("Invalid pattern format", true);
                }
            } else {
                showMessage("No saved pattern found", true);
            }
        } catch (error) {
            console.error("Load error:", error);
            showMessage("Load error", true);
        }
    }

    // Grid Aesthetic Enhancement
    function createGrid() {
        sequencerContainer.innerHTML = '';
        for (let i = 0; i < notes.length; i++) {
            const row = document.createElement('div');
            row.className = 'flex items-center mb-1';

            // Note label on left
            const label = document.createElement('span');
            label.textContent = noteLabels[i];
            label.className = 'w-5 mr-2 text-center text-gray-500 text-xs md:text-base font-semibold font-mono';
            row.appendChild(label);

            for (let j = 0; j < numSteps; j++) {
                const cell = document.createElement('div');
                cell.className = `sequencer-cell w-7 h-7 md:w-9 md:h-9 border border-gray-300 mx-0.5 rounded-full shadow-sm cursor-pointer transition-all duration-200 ${noteOffColor} hover:bg-indigo-100 hover:shadow-md`;
                cell.tabIndex = 0;
                cell.setAttribute('role', 'button');
                cell.setAttribute('aria-label', `${noteLabels[i]} step ${j+1}`);
                cell.dataset.row = i;
                cell.dataset.col = j;
                cell.addEventListener('click', () => toggleCell(i, j, cell));
                cell.addEventListener('keydown', (evt) => {
                  if(evt.key === " " || evt.key === "Enter") {
                    evt.preventDefault();
                    toggleCell(i, j, cell);
                  }
                });
                row.appendChild(cell);
            }
            sequencerContainer.appendChild(row);
        }
    }

    function toggleCell(i, j, cell) {
        grid[i][j] = !grid[i][j];
        cell.classList.toggle(noteOnColor, grid[i][j]);
        cell.classList.toggle(noteOffColor, !grid[i][j]);
        cell.classList.toggle('ring-2', grid[i][j]);
        cell.classList.toggle('ring-indigo-400', grid[i][j]);
    }

    /** Update grid and UI */
    function setGrid(newGrid, triggerUI = false) {
      grid = newGrid.map(row => [...row]);
      for (let i = 0; i < notes.length; i++) {
        for (let j = 0; j < numSteps; j++) {
          const cell = sequencerContainer.children[i].children[j+1]; // first is label
          if (cell) {
              cell.classList.toggle(noteOnColor, grid[i][j]);
              cell.classList.toggle(noteOffColor, !grid[i][j]);
              cell.classList.toggle('ring-2', grid[i][j]);
              cell.classList.toggle('ring-indigo-400', grid[i][j]);
          }
        }
      }
      if (triggerUI) {
        showMessage("Pattern loaded ðŸŽ¶");
      }
    }

    /** PLAY/PULSE */
    function highlightStep(stepIdx) {
      // Remove highlight
      for (let i = 0; i < notes.length; i++) {
        for (let j = 0; j < numSteps; j++) {
          const cell = sequencerContainer.children[i].children[j+1];
          cell.classList.remove(highlightColor, "scale-110");
        }
      }
      for (let i = 0; i < notes.length; i++) {
        const cell = sequencerContainer.children[i].children[stepIdx+1];
        if (cell) {
          cell.classList.add(highlightColor, "scale-110");
        }
      }
    }

    function clearHighlight() {
      for (let i = 0; i < notes.length; i++) {
        for (let j = 0; j < numSteps; j++) {
          const cell = sequencerContainer.children[i].children[j+1];
          cell.classList.remove(highlightColor, "scale-110");
        }
      }
    }

    function startPlayback() {
        if (loop) return;
        Tone.Transport.start();
        loop = new Tone.Loop(time => {
            const step = currentStep % numSteps;
            highlightStep(step);
            notes.forEach((note, nidx) => {
                if (grid[nidx][step]) {
                    synth.triggerAttackRelease(note, '8n', time);
                }
            });
            currentStep++;
        }, "8n").start(0);

        playButton.innerHTML = `<svg class="w-4 h-4 mr-1 animate-pulse inline" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"></polygon></svg> Playing`;
        playButton.disabled = true;
        stopButton.disabled = false;
    }

    function stopPlayback() {
        Tone.Transport.stop();
        if (loop) {
            loop.dispose();
            loop = null;
        }
        currentStep = 0;
        clearHighlight();
        playButton.innerHTML = `<svg class="w-4 h-4 mr-1 inline" fill="currentColor" viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"></polygon></svg> Play`;
        playButton.disabled = false;
        stopButton.disabled = true;
    }

    // Save to localStorage
    saveButton.addEventListener('click', savePattern);

    // Load from localStorage
    loadButton.addEventListener('click', loadPattern);

    // Clear
    document.getElementById('clear-btn').addEventListener('click', () => {
        stopPlayback();
        grid = Array.from({length: notes.length}, () => Array(numSteps).fill(false));
        setGrid(grid);
        showMessage("Grid cleared");
    });

    // Tempo
    tempoSlider.addEventListener('input', (e) => {
        Tone.Transport.bpm.value = +e.target.value;
        document.getElementById('tempo-display').textContent = `${e.target.value} BPM`;
    });

    // Controls
    playButton.addEventListener('click', startPlayback);
    stopButton.addEventListener('click', stopPlayback);

    // Keyboard convenient shortcuts ('Space': play/stop, 'c': clear)
    document.addEventListener('keydown', evt => {
        if (document.activeElement !== document.body) return;
        if (evt.code === 'Space') {
            evt.preventDefault();
            if (!loop) startPlayback(); else stopPlayback();
        } else if (evt.key.toLowerCase() === 'c') {
            document.getElementById('clear-btn').click();
        }
    });

    // Onload
    window.onload = () => {
      createGrid();
      Tone.start();
      Tone.Transport.bpm.value = tempoSlider.value;
      stopButton.disabled = true;
      playButton.disabled = false;
      document.getElementById('tempo-display').textContent = `${tempoSlider.value} BPM`;
    };

    </script>
    <style>
      .sequencer-cell-highlight {
          transition: background-color 0.1s cubic-bezier(.4,.4,.2,1), transform 0.1s;
      }
      /* Scrollbar for grid if needed on small devices */
      #sequencer {
        scrollbar-color: #b4b4b4 #f5f5f5;
      }
      #sequencer::-webkit-scrollbar {
        height: 4px; background: #f5f5f5;
      }
      #sequencer::-webkit-scrollbar-thumb {
        background: #bbb; border-radius: 3px;
      }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-indigo-100 flex items-center justify-center min-h-screen font-sans">
  <main class="bg-white/90 backdrop-blur-md rounded-2xl shadow-2xl p-6 md:p-10 max-w-5xl w-full flex flex-col items-center space-y-7 border border-indigo-100">
    <header class="text-center space-y-1">
      <h1 class="text-4xl md:text-5xl font-extrabold text-indigo-800 drop-shadow">Melody Sequencer</h1>
      <p class="mt-1 text-base md:text-lg text-gray-500">Create, play, and save your melody patterns!</p>
    </header>
    <!-- Sequencer Grid -->
    <section id="sequencer" class="bg-white py-5 px-0 md:px-6 rounded-xl shadow-inner border-2 border-indigo-100 overflow-auto" style="min-width: min(677px, 98vw)">
      <!-- Grid is built here -->
    </section>
    <!-- Controls Row -->
    <nav aria-label="Controls" class="flex flex-wrap justify-center gap-2 md:gap-4 w-full">
      <button id="play-btn" class="flex items-center px-6 py-3 bg-green-500 text-white font-bold rounded-full shadow-lg hover:bg-green-600 focus:ring-2 ring-green-400 transition-all transition-transform hover:scale-105 outline-none" aria-label="Play">
        <svg class="w-4 h-4 mr-1 inline" viewBox="0 0 24 24" fill="currentColor"><polygon points="5,3 19,12 5,21"></polygon></svg> Play
      </button>
      <button id="stop-btn" class="flex items-center px-6 py-3 bg-red-500 text-white font-bold rounded-full shadow-lg hover:bg-red-600 focus:ring-2 ring-red-400 transition-all hover:scale-105 outline-none" aria-label="Stop">
        <svg class="w-4 h-4 mr-1 inline" viewBox="0 0 24 24" fill="currentColor"><rect x="5" y="5" width="14" height="14" rx="2"></rect></svg> Stop
      </button>
      <button id="clear-btn" class="flex items-center px-6 py-3 bg-gray-400 text-white font-bold rounded-full shadow-lg hover:bg-gray-500 focus:ring-2 ring-gray-400 transition-all hover:scale-105 outline-none" aria-label="Clear">
        <svg class="w-4 h-4 mr-1 inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        Clear
      </button>
      <button id="save-btn" class="flex items-center px-6 py-3 bg-indigo-600 text-white font-bold rounded-full shadow-lg hover:bg-indigo-700 focus:ring-2 ring-indigo-400 transition-all hover:scale-105 outline-none" aria-label="Save">
        <svg class="w-4 h-4 mr-1 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V7a2 2 0 012-2h2l2-2h4l2 2h2a2 2 0 012 2v12a2 2 0 01-2 2z"></path></svg>
        Save
      </button>
      <button id="load-btn" class="flex items-center px-6 py-3 bg-purple-600 text-white font-bold rounded-full shadow-lg hover:bg-purple-700 focus:ring-2 ring-purple-400 transition-all hover:scale-105 outline-none" aria-label="Load">
        <svg class="w-4 h-4 mr-1 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M12 19V6m0 13l-6-6m6 6l6-6"></path></svg>
        Load
      </button>
    </nav>
    <!-- Tempo Slider/Display -->
    <div class="w-full max-w-xs text-center space-y-2">
      <label for="tempo" class="text-sm md:text-base font-semibold text-gray-700 select-none">Tempo: <span id="tempo-display" class="align-text-bottom">120 BPM</span></label>
      <div class="flex items-center gap-2">
        <span class="text-xs text-gray-400">60</span>
        <input type="range" id="tempo" min="60" max="240" value="120"
          class="w-full h-2 bg-gray-300 rounded-lg appearance-none accent-indigo-500 focus:accent-indigo-700 cursor-pointer border border-indigo-100 transition-all">
        <span class="text-xs text-gray-400">240</span>
      </div>
    </div>
    <!-- Status Message -->
    <div class="relative w-full text-center h-8">
      <div id="status-message" class="absolute inset-0 flex items-center justify-center text-sm font-medium text-gray-700 hidden"></div>
    </div>
    <footer class="pt-4 text-xs text-gray-400 text-center select-none">Â© Melody Sequencer â€¢ Built with <span class="text-indigo-400">Tone.js + LocalStorage</span></footer>
  </main>
</body>
</html>
